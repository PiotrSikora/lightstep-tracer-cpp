machine:
  services:
    - docker
  environment:
    GOPATH: ${HOME}/go
    BUILD_DIR: ${GOPATH}/src/github.com/${CIRCLE_PROJECT_USERNAME}/${CIRCLE_PROJECT_REPONAME}
    GOOGLE_APPLICATION_CREDENTIALS: ${HOME}/gcloud-service-key.json
    HELM_INSTALL_DIR: ${HOME}/bin

dependencies:
  pre:

dependencies:
  pre:
    # Pull scripts from a shared repo
    - cd ${HOME} && git clone git@github.com:lightstep/prod.git
    # Do this before the build so it can be cached
    - ${HOME}/prod/scripts/circleci-init.sh
    # Move the build target into its proper Go place
    - mkdir -p ${GOPATH}/src/github.com/${CIRCLE_PROJECT_USERNAME}
    - mv ${HOME}/${CIRCLE_PROJECT_REPONAME} ${BUILD_DIR}
    # Symlink back to make CircleCI tools happier
    - ln -s ${BUILD_DIR} ${HOME}/${CIRCLE_PROJECT_REPONAME}

    # Note the similarities with lightstep-benchmarks/scripts/docker/Dockerfile.build_cpp
    - sudo apt-get update; sudo apt-get install autoconf cmake automake git-core libtool pkg-config wget curl unzip

    - git clone -b 3.0.x https://github.com/google/protobuf && cd protobuf && ./autogen.sh && ./configure --prefix=/usr/local && make && make check && make install

    - git clone -b v1.0.1 https://github.com/grpc/grpc && cd grpc && git submodule update --init && make && make install prefix=/usr/local

  override:
    - cd ${BUILD_DIR} && sh bootstrap.sh && sh configure && make distcheck
    - cd ${BUILD_DIR} && sh bootstrap.sh && sh configure --disable-grpc && make distcheck
  cache_directories:
    - /opt/google-cloud-sdk
    - ~/bin
    - ~/.helm

experimental:
  notify:
    # Reduce slack noise from failed WIP branch builds
    branches:
      only: [master]
